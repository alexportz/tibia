<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIBIA</title>
    <style type="text/css">
        body {
            background:#000;
            margin:0;
            padding:0;
            box-sizing: border-box;
            overflow:hidden;
        }
        #tela {
            background: url('sprites/ui-background.png');
        }
    </style>
</head>
<body>
    <canvas id="tela"></canvas>

    <script type="module">
        //IMPORTA ARQUIVOS EXTERNOS
        import Sqm from "/js/Sqm.js";
        import Mapa from "/js/Mapa.js";
        import Player from "/js/Player.js";

        const cnv = document.querySelector("#tela");
        const ctx = cnv.getContext("2d");

        //DEFINE TAMANHO DO CANVAS
        cnv.width = innerWidth;
        cnv.height = innerHeight;

        //Definições Iniciais
        let sqmSizeX = 32;
        let sqmSizeY = 32;
        //Define o tamanho do Player(render)
        let playerSizeX = 64;
        let playerSizeY = 64;
        //Define tela Visual do Game
        let maxSqmX = 15;
        let maxSqmY = 11;

        let sqmDefaultSize = sqmSizeX; //Define tamanho padrão do SQMGeral
        let meioTelaX = innerWidth/2; //Define meio da telaX ao abrir o browser
        let meioTelaY = innerHeight/2; //Define meio da telaY ao abrir o browser
        let totalSqms = maxSqmX * maxSqmY; //Define total de SQMs do MapaView
        let margemX = innerWidth - (maxSqmX * sqmSizeX); //Define Margem esquerda de Acordo com o MapaView.
        let margemY = innerHeight - (maxSqmY * sqmSizeY); //Define Margem direita de Acordo com o MapaView.
        
        //Instancia o MAPView
        let mapaView = new Mapa(ctx,0,0,0,0,sqmSizeX,sqmSizeY,maxSqmX,maxSqmY,"#c2c2c2",innerWidth,innerHeight);
           

        //AJUSTE RESOLUÇÃO
        addEventListener("resize", function(){
            //Atualiza Canva e Redesenha View Port
            atualizaCanvaSize(); //Att tamanho da tela do Canva
            atualizaMapView(); //Att tamanho do ViewMap (area visual do Mapa)
            atualizaPlayer(); //Att posicao do player
        })


        //DEFINE A SPRITE USADA
        const spriteMapa = new Image();
              spriteMapa.src = "sprites/mapa.png";
        const spritePlayer = new Image();
              spritePlayer.src = "sprites/player-cyc.png";

        //INSTANCIA O PLAYER VAZIO
        let playerPrincipal = null;

        function startGame(){
            
            //CRIA O PLAYER "Define as conf. do Player"
            createPlayer(playerPrincipal);

            //INICIA O LOOP DO GAME
            loopGame();
        }

        //FUNÇÃO DE LOOP
        function loopGame(){
            //Limpa todo o canvas (TelaInteira)
            ctx.clearRect(0,0,innerWidth,innerHeight);

            //Desenha os SQM na tela
            sqmDraw();
            mapaView.draw();

            //RENDERIZA O PLAYER NA TELA
            playerPrincipal.renderiza();

            //DESENHA LINHAS DE CENTRO DA TELA
            centroDaTela();

            //CHAMA A MESMA FUNÇÃO
            requestAnimationFrame(loopGame);
        }

        //FUNÇÃO DESENHA OS SQM
        function sqmDraw(){
            //VARIAL
            let posRenderX = 0;
            let posRenderY = 32;
            let posDoSqmX = mapaView.position.x;
            let posDoSqmY = mapaView.position.y;

            //CRIA LOOP FOR PARA OS SQM
            for (let i=0; i < totalSqms; i++){

                //Cria Variavel do SQM
                let meuSqm = new Sqm(
                    ctx,
                    posDoSqmX,
                    posDoSqmY,
                    sqmSizeX,
                    sqmSizeY,
                    spriteMapa,
                    posRenderX,
                    posRenderY,
                    sqmSizeX,
                    sqmSizeY,
                    posDoSqmX,
                    posDoSqmY,
                    sqmSizeX,
                    sqmSizeY
                );
                
                //RENDERIZA SQM
                meuSqm.renderiza();

                //Acrescenta novo valor na posX
                posDoSqmX += sqmSizeX;

                //ZERA POSICOES NO LIMETE DO MAPA
                let larguraDoMapaView = mapaView.size.w;
                let gapMapaView = (innerWidth - larguraDoMapaView) / 2;
            
                if( posDoSqmX >= (larguraDoMapaView + gapMapaView) ){
                    posDoSqmX = mapaView.position.x;
                    posDoSqmY += sqmSizeY;
                }
            }
        }
 
        //CARREGA O GAME
        spriteMapa.onload = function(){
            // console.log("Carregou o Sprite");
            startGame();
        }


        //********* FUNÇÕES **************//
        //CRIA O PLAYER PRINCIPAL
        function createPlayer(){
            //DEFINE AS PROPRIEDADES DO PLAYER
            let sizeSpriteW = playerSizeX;
            let sizeSpriteH = playerSizeY;
            let areaHitX = sqmDefaultSize;
            let areaHitY = sqmDefaultSize;
            let areaHitW = sqmDefaultSize;
            let areaHitH = sqmDefaultSize;
            let spriteRenderX = 0;
            let spriteRenderY = 0;
            let marginX = areaHitW/2;
            let marginY = areaHitH/2;
    
            //POSICIONA PLAYER NA TELA
            let positionPlayerX = (meioTelaX - sizeSpriteW) + areaHitW - marginX;
            let positionPlayerY = (meioTelaY - sizeSpriteH) + areaHitH - marginY;

            playerPrincipal = new Player(
                ctx,
                positionPlayerX,
                positionPlayerY,
                sizeSpriteW,
                sizeSpriteH,
                spritePlayer,
                spriteRenderX,
                spriteRenderY,
                sizeSpriteW,
                sizeSpriteH,
                positionPlayerX,
                positionPlayerY,
                sizeSpriteW,
                sizeSpriteH,
                areaHitX,
                areaHitY,
                areaHitW,
                areaHitH,
                marginX,
                marginY
            );
        }
        //ATUALIZA CANVA SIZE
        function atualizaCanvaSize(){
            //REDEFINE TAMANHO DO CANVAS
            cnv.width = innerWidth;
            cnv.height = innerHeight;
        }
        //ATUALIZAR POSICAO DO MAP VIEW
        function atualizaMapView() {
            //Atualiza o TAMANHO da Tela e resdesenha MAP VIEW
            mapaView.screenSize.w = innerWidth;
            mapaView.screenSize.h = innerHeight;
            mapaView.attPosition();
            mapaView.draw();
        }
        //ATUALIZAR POSICAO PLAYER
        function atualizaPlayer() {
            //POSICIONA PLAYER NA TELA //Att posição Player referente a tela
            let sizeSpriteW = playerPrincipal.render.sw;
            let sizeSpriteH = playerPrincipal.render.sh;
            let areaHitW = playerPrincipal.areahit.w;
            let areaHitH = playerPrincipal.areahit.h;
            let marginX = areaHitW/2;
            let marginY = areaHitH/2;
                meioTelaX = innerWidth/2;
                meioTelaY = innerHeight/2;

            let positionPlayerX = (meioTelaX - sizeSpriteW) + areaHitW - marginX;
            let positionPlayerY = (meioTelaY - sizeSpriteH) + areaHitH - marginY;

            playerPrincipal.render.px = positionPlayerX;
            playerPrincipal.render.py = positionPlayerY;
        }
        //DESENHA LINHAS DE GUIA DE CENTRO DA TELA
        function centroDaTela(){
            let meioTelaHorizontal = innerHeight/2;
            let meioTelaVertical = innerWidth/2;

            ctx.strokeStyle = "#F00";
            ctx.beginPath();
            ctx.moveTo(0, meioTelaHorizontal);
            ctx.lineTo(innerWidth, meioTelaHorizontal);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(meioTelaVertical, 0);
            ctx.lineTo(meioTelaVertical, innerHeight);
            ctx.stroke();
        }
        //********* FIM DAS FUNÇÕES **************//

    </script>


</body>
</html>