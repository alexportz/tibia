<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIBIA</title>
    <style type="text/css">
        body {
            background:#000;
            margin:0;
            padding:0;
            box-sizing: border-box;
            overflow:hidden;
        }
        #tela {
            background:#000;
        }
    </style>
</head>
<body>
    <canvas id="tela"></canvas>

    <script type="module">
        //IMPORTA ARQUIVOS EXTERNOS
        import Sqm from "/js/Sqm.js";
        import Mapa from "/js/Mapa.js";

        const cnv = document.querySelector("#tela");
        const ctx = cnv.getContext("2d");

        //DEFINE TAMANHO DO CANVAS
        cnv.width = innerWidth;
        cnv.height = innerHeight;

        //Definições Iniciais
        let sqmSizeX = 32;
        let sqmSizeY = 32;

        //Define tela Visual do Game
        let maxSqmX = 15;
        let maxSqmY = 11;
        let totalSqms = maxSqmX * maxSqmY;
        let mapaView = new Mapa(ctx,0,70,0,0,sqmSizeX,sqmSizeY,maxSqmX,maxSqmY,"#c2c2c2",innerWidth,innerHeight);
            mapaView.draw();
  

        //AJUSTE RESOLUÇÃO
        addEventListener("resize", function(){
            //console.log("Alterou Resolução");
            
            //REDEFINE TAMANHO DO CANVAS
            cnv.width = innerWidth;
            cnv.height = innerHeight;

            //Atualiza Canva e Redesenha View Port
            atualizaMapView();
            
        })


        //DEFINE A SPRITE USADA
        const spriteMapa = new Image();
              spriteMapa.src = "sprites/mapa.png";
        const spritePlayer = new Image();
              spritePlayer.src = "sprites/player-cyc.png";
 
        function startGame(){
            loopGame();
        }

        //FUNÇÃO DE LOOP
        function loopGame(){
            ctx.clearRect(0,0,innerWidth,innerHeight);
            sqmDraw();
            renderizaPlayer();
            centroDaTela();
            requestAnimationFrame(loopGame);
        }

        //FUNÇÃO DESENHA OS SQM
        function sqmDraw(){
            //VARIAL
            let posRenderX = 0;
            let posRenderY = 32;
            let posDoSqmX = mapaView.position.x;
            let posDoSqmY = mapaView.position.y;

            //CRIA LOOP FOR PARA OS SQM
            for (let i=0; i < totalSqms; i++){

                ctx.save();
                ctx.strokeStyle = "#0F0";
                ctx.strokeRect(posDoSqmX,posDoSqmY,sqmSizeX,sqmSizeY);
                ctx.restore();

                //Cria Variavel do SQM
                let meuSqm1 = new Sqm(ctx,posDoSqmX,posDoSqmY,sqmSizeX,sqmSizeY,spriteMapa,posRenderX,posRenderY,sqmSizeX,sqmSizeY,posDoSqmX,posDoSqmY,sqmSizeX,sqmSizeY);
                //RENDERIZA SQM
                meuSqm1.renderiza();
                //Acrescenta novo valor na posX
                posDoSqmX += sqmSizeX;

                //ZERA POSICOES NO LIMETE DO MAPA
                let larguraDoMapaView = mapaView.size.w;
                let gapMapaView = (innerWidth - larguraDoMapaView) / 2;
            
                if( posDoSqmX >= (larguraDoMapaView + gapMapaView) ){
                    posDoSqmX = mapaView.position.x;
                    posDoSqmY += sqmSizeY;
                }
                
            }
        }
 
        //CARREGA O GAME
        spriteMapa.onload = function(){
            console.log("Carregou o Game");
            startGame();
        }

        //FUNÇÕES//
        //ATUALIZAR POSICAO DO MAP VIEW
        function atualizaMapView() {
            //Atualiza o TAMANHO da Tela e resdesenha MAP VIEW
            mapaView.screenSize.w = innerWidth;
            mapaView.screenSize.h = innerHeight;
            mapaView.attPosition();
            mapaView.draw();
        }

        function centroDaTela(){
            let meioTelaHorizontal = innerHeight/2;
            let meioTelaVertical = innerWidth/2;

            ctx.strokeStyle = "#F00";
            ctx.beginPath();
            ctx.moveTo(0, meioTelaHorizontal);
            ctx.lineTo(innerWidth, meioTelaHorizontal);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(meioTelaVertical, 0);
            ctx.lineTo(meioTelaVertical, innerHeight);
            ctx.stroke();
        }

        //RENDERIZA PLAYER
        function renderizaPlayer(){
            let posPlayerX = innerWidth/2 - (64/2) - (32/2);
            let posPlayerY = innerHeight/2 - (64/2) - (32/2);
            let sx = 0;
            let sy = 0;
            let sw = 64;
            let sh = 64;

            let px = posPlayerX;
            let py = posPlayerY;
            let pw = 64;
            let ph = 64;

            ctx.fillStyle = "#00F";
            ctx.drawImage(spritePlayer,sx,sy,sw,sh,px,py,pw,ph);
            // ctx.fillRect(posPlayerX,posPlayerY,64,64);
        }
        

    </script>


</body>
</html>